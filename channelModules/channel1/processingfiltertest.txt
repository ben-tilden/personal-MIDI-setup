// processing filter

@Onload

  // minimal layout
  ShowLayout 4

  intervalCCValues = [0, 6, 11, 16, 21, 26, 31, 36, 41, 46, 51, 56, 61, 67, 72, 77, 82, 87, 92, 97, 102, 107, 112, 117, 122, 127]

  // variable

  midiCCStandard = 0
  midiCCInterval = 0
  intervalDepth = 64
  FillArray trackingMode, 0, 6
  FillArray intervalDepth, 0, 6

@End

// sysex reception

@OnMIDINoteOn

  // channel specific
  // chromaticize keys volca drum if tracking is on
  if MIDIChannel < 6 and trackingMode[MIDIChannel] <> 0 and MIDINote >= 0 and MIDINote < 126
    // send the channel, pitch control, and note number
    midiCCStandard = MIDINote + 1 // 1 is the offset here to align properly - this means the highest possible note is F# (126)
  if trackingMode[MIDIChannel] = 1
      // intervalDepth is divided into 25 separate groups, ranging 5 values from -12 to +12 semitones (with quantized pitch)
      // midiCCInterval has the potential to send messages which will cause issues if it goes below zero / above 126
      // including conditionals to prevent this
      for i = 0 to 24
        intervalValue = (i - 12) * 2 // -24 to 24

        if intervalDepth < intervalCCValues[i + 1] and intervalDepth >= intervalCCValues[i]
          midiCCInterval = midiCCStandard + intervalValue

          if midiCCInterval >= -26 and midiCCInterval < 127
            SendMIDICC MIDIChannel, 0x1A, midiCCStandard
            SendMIDICC MIDIChannel, 0x1B, midiCCInterval

          elseif midiCCInterval >= 127
            SendMIDICC MIDIChannel, 0x1A, midiCCStandard
            SendMIDICC MIDIChannel, 0x1B, 126

          elseif midiCCInterval < -26
            SendMIDICC MIDIChannel, 0x1A, midiCCStandard
            SendMIDICC MIDIChannel, 0x1B, 1

          endif         
        endif
      endfor

    endif
  endif
  // end channel specific

  SendMIDIThru

@End

@OnMIDINoteOff

  SendMIDIThru

@End

@OnMIDICC

  if MIDIByte2 = 0x69 and MIDIByte3 = 0x7F
    trackingMode[MIDIChannel] = (trackingMode[MIDIChannel] + 1) % 2
    if trackingMode[MIDIChannel] = 1
      SendMIDICC MIDIChannel, 53, 127
    endif
    Exit

  elseif MIDIChannel < 6 and MIDIByte2 = 0x7E
    intervalDepth[MIDIChannel] = sysexData[4]
    Exit
  
  else
    SendMIDIThru
    Exit

  endif

@End
